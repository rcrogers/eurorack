# Interface

### Global control and display of the active part and its play mode
- Display periodically flashes the active part and its play mode (while in the parameter menu)
- Hold `START` to switch the active part (the new active part will flash briefly on the screen).  The active part is used for:
  - Selecting the recording part when pressing `REC`
  - Front-panel latching (hold `REC`)
  - Editing part-specific settings
- Hold/long-press `TAP` to switch the play mode for the active part (the new play mode will flash).  Play modes are:
  - **`M`anual**: Output is generated by the MIDI controller only
  - **`S`equencer**: Output is generated by the sequencer (and by the MIDI controller depending on `SI (SEQ INPUT RESPONSE)` -- see below)
  - **`A`rpeggiator**: Output is generated by the sequencer-driven arpeggiator (see below)

### Tap tempo changes
- If a single tap is received without follow-up, the tempo is set to use external clocking
- After setting a tempo, the result flashes on the screen

### Other tweaks
- Moved configuration-type settings into a submenu, accessed by opening `â–½S (SETUP MENU)`.  Settings relevant to live performance remain in the top-level menu
- Print flat notes as lowercase character (instead of denoting flatness with `b`) so that octave can always be displayed
- Improved clock-sync of display fade for the `TE(MPO)` setting

# Synth voice

### Oscillator controls
- Configured via the `â–½O (OSCILLATOR MENU)`
- `OM (OSCILLATOR MODE)` switches the oscillator between `OFF`, `DRONE`, and `ENVELOPED`
- `OS (OSCILLATOR SHAPE)` sets the waveform
- A pulse-width modulated rectangle wave replaces the "25% rectangle" wave
  - The modulating LFO for the PWM is the quadrature of the vibrato LFO
  - `OSC PW INITIAL` sets initial pulse width
  - `OSC PW MOD` sets the bipolar depth of pulse width modulation by the LFO

### ADSR envelopes, modulated by velocity
- Configured via the `â–½ðŸ“‰ (ENVELOPE MENU)`
- Controls voice amplitude when the `OSCILLATOR MODE` is `ENVELOPED`
- Available as an assignable CV output (`ENVELOPE`) in all layouts
- The envelope's amplitude and its sensitivity to velocity are set by `GAIN INIT` and `GAIN MOD`
- The envelope's segments and their sensitivity to velocity are set by `ATTACK TIME INIT`, `ATTACK TIME MOD`, etc.
  - Segment times range from 0.375 ms (3 ticks) to 3 seconds
  
# Sequencer

### Recording interface changes
- Hold `REC` to clear sequence
- First `REC` press switches the display to show the pitch instead of the step number (press again to exit recording)
- Flash note (or RS/TI) for the selected step
- Brighten display while the selected step is being played
- Wrap around around when using encoder to scroll through steps

### Looper-style sequencing mode with real-time recording
- To enable, ensure `SM (SEQ MODE)` is set to `LOOP`
- To record or overdub, press `REC` to enter real-time recording mode, then use the keyboard
- While recording, delete the oldest note by pressing `START`, newest by `TAP`
- Loop length is set by the `L- (LOOP LENGTH)` in quarter notes, as applied to the part's `C/`
- Note start/end times are recorded at 13-bit resolution (1/8192 of the loop length)
- Holds 31 notes max -- past this limit, overwrites oldest note
- Step sequencer also reduced from 64 to 31 notes, to free up space in the preset storage

### Sequencer-driven arpeggiator
- Activated by setting the `ARP PATTERN` to `SEQUENCER`
- Arpeggiator is driven by looper/sequencer notes instead of by clock pulses -- a sequence must exist to produce arpeggiator output
- The arpeggiator respects rests/ties in the sequence
- The velocity of the arpeggiator output is the product of the velocities of the sequencer step and the held key
- New arpeggiator directions that use the note pitch as movement instructions:
  - Notes are interpreted based on key color (black/white) and distance above/below middle C
  - `ROTATE` treats white keys as relative movement through the chord, and black keys as absolute positions in the chord
  - `SUBROTATE` generates quasi-cartesian patterns

# MIDI

### Layouts
- `22` 3-part layout: one two-voice polyphonic part, two monophonic parts
- `21` 2-part layout: 2-voice polyphonic part, monophonic part with modulation output
- `*2` 3-part layout: 3-voice paraphonic part, 1 monophonic part with modulation, 1 monophonic part without modulation
  - Paraphonic part can use the new [envelopes](#adsr-envelopes-with-velocity-control)
  - Audio mode is always on for the paraphonic part
  - Output channels:
    1. Part 1, 3 voices mixed to 1 audio output
    2. Part 2, monophonic CV/gate
    3. Part 2, modulation configurable via `3>`
    4. Part 3, monophonic CV/gate
    
### Hold pedal
- Screen flashes the active part's hold status
  - Tick marks show the number of keys that are held, sustainable, sustained, and/or about to be released
  - Limited to the 6 most recent keys due to display size
- New `HM (HOLD PEDAL MODE)` setting to change the part's response to the hold pedal
  - `OFF` ignores the pedal
  - `SUSTAIN` is the stock firmware behavior (no notes are released as long as the pedal is down)
  - `SOSTENUTO` sustains only the notes held at the time the pedal goes down
  - `LATCH` uses the semantics of the front-panel latching in stock Yarns
  - `MOMENTARY LATCH` is identical to `LATCH`, except that it releases latched notes as soon as the pedal is released, instead of on the next note
  - `CLUTCH UP` is a hybrid of `SOSTENUTO` and `LATCH` -- when the pedal goes down, sustains any held notes; while the pedal is up, pressing any note will release held notes
  - `CLUTCH DOWN` is the same as `CLUTCH UP`, but with reversed up/down semantics
- New `HP (HOLD PEDAL POLARITY)` setting to switch between [negative and positive pedal polarity](http://www.haydockmusic.com/reviews/sustain_pedal_polarity.html)

### Event routing, filtering, and transformation
- New `SI (SEQ INPUT RESPONSE)` setting changes how a playing sequence responds to manual input
  - `OFF` ignores keyboard input
  - `TRANSPOSE` is the stock firmware behavior
  - `REPLACE` retains the sequence's rhythm, but overrides its pitch
  - `DIRECT` gives full use of the keyboard, allowing accompaniment of a sequence, etc.
- New `IT (INPUT TRANSPOSE OCTAVES)` setting to apply transposition to notes received by a part
  - Effectively an octave switch for the controller
  - Ignored when using the step to control arpeggiator movement
- Parts can filter notes by velocity
  - Added UI for previously hidden settings `V> (VELOCITY MIN)` and `V< (VELOCITY MAX)`
  - Present for all layouts except 4V
  - Output velocity range is scaled to compensate for the restricted range imposed by input filtering
- Recording 
  - Any MIDI events ignored by the recording part can be received by other parts
  - Recording part now responds to MIDI start
  
### Expanded support for Control Change events
- The result of a received CC is briefly displayed
- Recording control: start/stop recording mode, delete a recording
- CC support for all new settings
- Fixed settings to accept a negative value via CC
- [Implementation Chart](https://docs.google.com/spreadsheets/d/1V6CRqf_3FGTrNIjcU1ixBtzRRwqjIa1PaiqOFgf6olE/edit#gid=0)

### Clock ratios
- Added a variety of integer ratios for `O/` and `C/` (and for clock-synced `VS (VIBRATO SPEED)`)
- [Includes 1/8, 3/7, 2/3, 6/5, 4/3, and more](./clock_division.h#L43)

### Vibrato
- New setting `VI(BRATO AMP INITIAL)` for setting a baseline vibrato amplitude when the vibrato controller is absent or at its minimum
- Tweaks to per-voice vibrato LFO for parts in polyphonic layouts:
  - When vibrato speed is synced to clock, each voice's LFO uses the quadrature of the previous voice
  - When vibrato speed is free-running, each voice's LFO frequency is slighter higher than the previous voice
  
### Other tweaks
- Fixed `UNISON` voice allocation methods to respect `NOTE PRIORITY` and allocate notes without gaps; added new `FIRST` setting to `NOTE PRIORITY`
- Voicing algorithms `UNISON 2` and `SORTED` reassign voices on `NoteOff` if there are held notes that don't yet have a voice
- Broadened portamento setting range from 51 to 64 values per curve shape
- Allow an explicit clock start (from panel switch or MIDI) to supersede an implicit clock start (from keyboard)
